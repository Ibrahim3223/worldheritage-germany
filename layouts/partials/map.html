{{- $lat := .latitude }}
{{- $lon := .longitude }}
{{- $title := .siteName }}
<div class="map-section">
  <div id="heritage-map" class="map-container w-full h-96 rounded-lg shadow-lg" data-lat="{{ $lat }}" data-lon="{{ $lon }}" data-title="{{ $title }}"></div>

  <!-- Nearby Sites (if available) -->
  {{ with $.Params.nearby_sites }}
  <div class="mt-6">
    <h4 class="text-lg font-semibold text-charcoal mb-3">Nearby Heritage Sites</h4>
    <ul class="space-y-2">
      {{ range . }}
      <li class="flex items-center text-stone">
        <svg class="w-4 h-4 mr-2 text-forest-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
        </svg>
        <a href="{{ .url }}" class="hover:text-forest-600">{{ .name }}</a>
        {{ with .distance }}<span class="text-sm text-stone/60 ml-2">({{ . }} km)</span>{{ end }}
      </li>
      {{ end }}
    </ul>
  </div>
  {{ end }}
</div>

<!-- Leaflet.js Map Script -->
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script defer>
document.addEventListener('DOMContentLoaded', function() {
  const mapContainer = document.getElementById('heritage-map');
  if (!mapContainer) return;

  const lat = parseFloat(mapContainer.dataset.lat);
  const lon = parseFloat(mapContainer.dataset.lon);
  const title = mapContainer.dataset.title;

  if (isNaN(lat) || isNaN(lon)) return;

  // Initialize map
  const map = L.map('heritage-map').setView([lat, lon], 15);

  // Add OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Custom marker icon
  const heritageIcon = L.divIcon({
    className: 'heritage-marker',
    html: `
      <div class="w-10 h-10 bg-forest-500 rounded-full flex items-center justify-center shadow-lg border-2 border-white">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
      </div>
    `,
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40]
  });

  // Add marker
  const marker = L.marker([lat, lon], { icon: heritageIcon }).addTo(map);

  // Add popup
  marker.bindPopup(`
    <div class="font-sans">
      <strong class="font-serif text-forest-800">${title}</strong>
      <br>
      <span class="text-sm text-stone">${lat.toFixed(6)}, ${lon.toFixed(6)}</span>
    </div>
  `);

  // Optional: Add nearby markers if data attribute exists
  const nearbySites = mapContainer.dataset.nearby;
  if (nearbySites) {
    try {
      const sites = JSON.parse(nearbySites);
      sites.forEach(site => {
        const nearbyIcon = L.divIcon({
          className: 'nearby-marker',
          html: `
            <div class="w-6 h-6 bg-sage-500 rounded-full flex items-center justify-center shadow border border-white">
              <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
              </svg>
            </div>
          `,
          iconSize: [24, 24],
          iconAnchor: [12, 24],
          popupAnchor: [0, -24]
        });

        L.marker([site.lat, site.lon], { icon: nearbyIcon })
          .addTo(map)
          .bindPopup(`<a href="${site.url}" class="font-semibold text-forest-600">${site.name}</a>`);
      });
    } catch (e) {
      console.warn('Could not parse nearby sites data');
    }
  }
});
</script>

<style>
.heritage-marker, .nearby-marker {
  background: transparent !important;
  border: none !important;
}

.leaflet-popup-content-wrapper {
  border-radius: 0.5rem;
  box-shadow: 0 4px 25px -5px rgba(0, 0, 0, 0.1);
}

.leaflet-popup-content {
  margin: 0.75rem 1rem;
}
</style>
