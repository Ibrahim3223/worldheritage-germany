<header class="sticky top-0 z-50 bg-white/95 backdrop-blur-sm shadow-soft" x-data="headerSearch()">
  <nav class="container-custom" aria-label="Main navigation">
    <div class="flex items-center justify-between h-16 md:h-20">
      <!-- Logo -->
      <a href="/" class="flex items-center space-x-1.5 md:space-x-3 group">
        <img src="/logo.png" alt="WorldHeritage.guide" class="h-8 md:h-12 w-auto flex-shrink-0">
        <div class="flex flex-col min-w-0">
          <div class="flex items-center">
            <span class="font-serif font-bold text-sm md:text-xl text-forest-800 truncate">WorldHeritage</span>
            <span class="text-forest-500 font-medium text-sm md:text-xl">.guide</span>
          </div>
          <span class="text-xs text-stone -mt-0.5">Germany</span>
        </div>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center space-x-8">
        {{ range .Site.Menus.main }}
        <a href="{{ .URL }}" class="nav-link {{ if $.IsMenuCurrent "main" . }}nav-link-active{{ end }}">
          {{ .Name }}
        </a>
        {{ end }}
      </div>

      <!-- Search & Mobile Menu Toggle -->
      <div class="flex items-center space-x-1 md:space-x-4">
        <!-- Search Button -->
        {{ if .Site.Params.enableSearch }}
        <button @click="searchOpen = !searchOpen" class="p-3 text-stone hover:text-forest-600 transition-colors" aria-label="Toggle search">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </button>
        {{ end }}

        <!-- Mobile Menu Button -->
        <button
          @click="mobileMenuOpen = !mobileMenuOpen"
          class="md:hidden p-3 text-stone hover:text-forest-600 transition-colors"
          aria-label="Toggle mobile menu"
          :aria-expanded="mobileMenuOpen"
        >
          <svg x-show="!mobileMenuOpen" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <svg x-show="mobileMenuOpen" x-cloak class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu - Simple Dropdown -->
    <div
      x-show="mobileMenuOpen"
      x-cloak
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 -translate-y-2"
      x-transition:enter-end="opacity-100 translate-y-0"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 translate-y-0"
      x-transition:leave-end="opacity-0 -translate-y-2"
      class="md:hidden border-t border-stone/10 py-4 bg-white"
    >
      <div class="flex flex-col space-y-1">
        {{ range .Site.Menus.main }}
        <a
          href="{{ .URL }}"
          class="px-4 py-3 text-base font-medium text-charcoal hover:bg-cream hover:text-forest-700 transition-colors rounded-lg {{ if $.IsMenuCurrent "main" . }}bg-forest-50 text-forest-700{{ end }}"
          @click="mobileMenuOpen = false"
        >
          {{ .Name }}
        </a>
        {{ end }}
      </div>
    </div>

    <!-- Search Overlay -->
    {{ if .Site.Params.enableSearch }}
    <div
      x-show="searchOpen"
      x-cloak
      @click.away="searchOpen = false"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="absolute left-0 right-0 top-full mt-1 bg-white shadow-2xl rounded-b-xl border border-sand/30 z-50"
      role="search"
      aria-label="Site search"
    >
      <div class="container-custom py-6 max-w-2xl mx-auto">

        <!-- Search Input -->
        <div class="relative mb-6">
          <label for="header-search-input" class="sr-only">Search heritage sites</label>
          <input
            type="text"
            id="header-search-input"
            x-model="query"
            @input="performSearch()"
            @keydown.escape="searchOpen = false"
            x-ref="searchInput"
            placeholder="Search heritage sites..."
            class="w-full px-4 py-3 pr-10 text-base border-2 border-sand focus:border-forest-500 rounded-lg focus:ring-2 focus:ring-forest-200/50 transition-all"
            aria-label="Search heritage sites"
          >
          <button
            type="button"
            @click="searchOpen = false"
            class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 text-stone hover:text-forest-600 transition-colors rounded hover:bg-sand/30"
            aria-label="Close search"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Search Results -->
        <div x-show="query.length >= 2" class="max-h-96 overflow-y-auto" role="region" aria-live="polite">

          <!-- Results -->
          <div x-show="results.length > 0" class="space-y-2" role="list">
            <template x-for="site in results" :key="site.url">
              <a
                :href="site.url"
                class="flex items-start gap-3 p-3 hover:bg-sage-50 rounded-lg transition-colors group"
              >
                <!-- Image -->
                <template x-if="site.image">
                  <div class="w-20 h-20 flex-shrink-0 rounded-lg overflow-hidden bg-sand">
                    <img
                      :src="site.image"
                      :alt="site.title"
                      class="w-full h-full object-cover"
                      loading="lazy"
                      decoding="async"
                      width="80"
                      height="80"
                    >
                  </div>
                </template>
                <template x-if="!site.image">
                  <div class="w-20 h-20 flex-shrink-0 rounded-lg bg-sand flex items-center justify-center">
                    <svg class="w-8 h-8 text-stone/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                  </div>
                </template>

                <!-- Content -->
                <div class="flex-1 min-w-0">
                  <h4 class="font-semibold text-charcoal group-hover:text-forest-600 transition-colors mb-1" x-text="site.title"></h4>
                  <div class="flex items-center gap-2 text-xs text-stone mb-1">
                    <span x-text="site.region"></span>
                    <span>•</span>
                    <span x-text="site.heritage_type"></span>
                  </div>
                  <span x-show="site.unesco" class="inline-block px-2 py-0.5 bg-forest-100 text-forest-700 rounded text-xs font-medium">UNESCO</span>
                </div>
              </a>
            </template>

            <!-- View All Link -->
            <div class="pt-3 mt-3 border-t border-sand">
              <a
                :href="'/search/?q=' + encodeURIComponent(query)"
                class="block text-center text-forest-600 hover:text-forest-700 font-medium text-sm py-2 hover:bg-sage-50 rounded-lg transition-colors"
              >
                View all results →
              </a>
            </div>
          </div>

          <!-- No Results -->
          <div x-show="query.length >= 2 && results.length === 0" class="text-center py-8">
            <p class="text-stone text-sm mb-3">No results found for "<span x-text="query" class="font-semibold text-charcoal"></span>"</p>
            <a href="/sites/" class="text-forest-600 hover:text-forest-700 font-medium text-sm">Browse all sites →</a>
          </div>
        </div>

      </div>
    </div>
    {{ end }}
  </nav>
</header>

<script>
function headerSearch() {
  return {
    searchOpen: false,
    mobileMenuOpen: false,
    query: '',
    results: [],
    searching: false,
    searchTimeout: null,

    allSites: [{{ range .Site.RegularPages.ByTitle }}{{ if eq .Section "sites" }}{
      title: {{ .Params.site_name | jsonify }},
      url: {{ .Permalink | jsonify }},
      description: {{ .Description | jsonify }},
      region: {{ .Params.region | jsonify }},
      heritage_type: {{ .Params.heritage_type | jsonify }},
      image: {{ if .Params.images }}{{ index .Params.images 0 | relURL | jsonify }}{{ else }}''{{ end }},
      unesco: {{ if in .Params.tags "unesco" }}true{{ else }}false{{ end }}
    },{{ end }}{{ end }}],

    init() {
      // Remove trailing comma from array
      if (this.allSites.length > 0 && !this.allSites[this.allSites.length - 1].title) {
        this.allSites = this.allSites.slice(0, -1);
      }

      this.$watch('searchOpen', value => {
        if (value) {
          this.$nextTick(() => {
            this.$refs.searchInput?.focus();
          });
        } else {
          this.query = '';
          this.results = [];
        }
      });
    },

    performSearch() {
      clearTimeout(this.searchTimeout);

      if (this.query.length < 2) {
        this.results = [];
        return;
      }

      this.searchTimeout = setTimeout(() => {
        this.searching = true;
        const q = this.query.toLowerCase();

        this.results = this.allSites.filter(site => {
          return site.title.toLowerCase().includes(q) ||
                 site.description.toLowerCase().includes(q) ||
                 site.region.toLowerCase().includes(q) ||
                 site.heritage_type.toLowerCase().includes(q);
        }).slice(0, 6);

        this.searching = false;
      }, 300);
    }
  };
}
</script>

<style>
  [x-cloak] { display: none !important; }
</style>
