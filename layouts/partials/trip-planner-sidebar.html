<!-- Trip Planner Sidebar - Pure CSS Animation -->
<div
  id="tripPlannerSidebar"
  x-data="{
    get store() { return $store.tripPlanner },
    clickOutsideEnabled: false
  }"
  x-init="console.log('[SIDEBAR] Initialized'); $store.tripPlanner.init();"
  @click.outside="if (clickOutsideEnabled && $store.tripPlanner.isOpen) { $store.tripPlanner.close(); }"
  @keydown.escape.window="$store.tripPlanner.close()"
  x-effect="if ($store.tripPlanner.isOpen) { setTimeout(() => clickOutsideEnabled = true, 300); } else { clickOutsideEnabled = false; }"
  class="flex-col"
  style="position: fixed; top: 0; right: -400px; height: 100vh; width: 384px; background: white; box-shadow: 0 0 50px rgba(0,0,0,0.3); z-index: 9999; display: none; flex-direction: column;"
>
  <!-- Header -->
  <div class="bg-gradient-to-br from-forest-800 to-charcoal text-white p-6 flex-shrink-0">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-serif font-bold text-white">Your Trip</h2>
      <button
        @click="$store.tripPlanner.close()"
        class="p-2 hover:bg-white/10 rounded-lg transition-colors text-white"
        aria-label="Close trip planner"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Trip Name -->
    <input
      type="text"
      x-model="$store.tripPlanner.tripName"
      @change="$store.tripPlanner.saveToStorage()"
      class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
      placeholder="Name your trip..."
    >

    <!-- Stats -->
    <div class="grid grid-cols-3 gap-4 mt-4 text-white">
      <div class="text-center">
        <div class="text-2xl font-bold" x-text="$store.tripPlanner.sites.length"></div>
        <div class="text-xs text-white/80">Sites</div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold" x-text="$store.tripPlanner.getDaysNeeded()"></div>
        <div class="text-xs text-white/80">Days</div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold" x-text="Math.round($store.tripPlanner.totalDistance)"></div>
        <div class="text-xs text-white/80">Km</div>
      </div>
    </div>
  </div>

  <!-- Site List -->
  <div class="flex-grow overflow-y-auto p-6">
    <!-- View Toggle -->
    <div
      x-data="{ view: 'list' }"
      class="mb-4"
    >
      <!-- Tabs -->
      <div class="flex gap-2 mb-4 border-b border-sand">
        <button
          @click="view = 'list'"
          :class="{ 'border-forest-600 text-forest-600': view === 'list', 'border-transparent text-stone': view !== 'list' }"
          class="px-4 py-2 font-semibold border-b-2 transition-colors"
        >
          All Sites
        </button>
        <button
          @click="view = 'itinerary'"
          :class="{ 'border-forest-600 text-forest-600': view === 'itinerary', 'border-transparent text-stone': view !== 'itinerary' }"
          class="px-4 py-2 font-semibold border-b-2 transition-colors"
        >
          Day by Day
        </button>
      </div>

      <!-- List View -->
      <div x-show="view === 'list'">
        <!-- Empty State -->
        <template x-if="$store.tripPlanner.sites.length === 0">
      <div class="text-center py-12">
        <div class="text-6xl mb-4">üó∫Ô∏è</div>
        <h3 class="text-xl font-serif font-bold text-charcoal mb-2">Start Planning!</h3>
        <p class="text-stone text-sm">Add sites to build your perfect heritage journey</p>
      </div>
    </template>

    <!-- Sites -->
    <template x-for="(site, index) in $store.tripPlanner.sites" :key="site.id">
      <div
        x-data="{ dragging: false }"
        :draggable="true"
        @dragstart="
          dragging = true;
          $event.dataTransfer.effectAllowed = 'move';
          $event.dataTransfer.setData('text/plain', index);
        "
        @dragend="dragging = false"
        @dragover.prevent="$event.dataTransfer.dropEffect = 'move'"
        @drop.prevent="
          const fromIndex = parseInt($event.dataTransfer.getData('text/plain'));
          if (fromIndex !== index) {
            $store.tripPlanner.reorder(fromIndex, index);
          }
        "
        :class="{ 'opacity-50': dragging, 'cursor-move': true }"
        class="bg-white rounded-xl shadow-soft border border-sand mb-3 p-3 hover:shadow-md transition-shadow"
      >
        <div class="flex gap-3">
          <!-- Drag Handle -->
          <div class="flex items-center text-stone hover:text-forest-600 cursor-move">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
            </svg>
          </div>

          <div class="w-8 h-8 rounded-full bg-forest-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">
            <span x-text="index + 1"></span>
          </div>
          <div class="flex-grow min-w-0">
            <h4 class="font-semibold text-charcoal text-sm mb-1 truncate" x-text="site.title"></h4>
            <div class="text-xs text-stone flex items-center gap-3">
              <span x-text="site.visitDuration + 'h'"></span>
              <span x-text="'‚Ç¨' + (site.entryFee || 0)"></span>
            </div>
          </div>
          <button
            x-data="{ siteId: site.id }"
            @click.stop="
              console.log('[BUTTON] Remove clicked!');
              console.log('[BUTTON] Site ID:', siteId);
              console.log('[BUTTON] Store:', $store.tripPlanner);
              $store.tripPlanner.removeSite(siteId);
            "
            type="button"
            class="p-1 text-stone hover:text-red-600 transition-colors flex-shrink-0"
            title="Remove site"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      </div>
    </template>
      </div>

      <!-- Itinerary View -->
      <div x-show="view === 'itinerary'">
        <!-- Empty State -->
        <template x-if="$store.tripPlanner.sites.length === 0">
          <div class="text-center py-12">
            <div class="text-6xl mb-4">üìÖ</div>
            <h3 class="text-xl font-serif font-bold text-charcoal mb-2">No Itinerary Yet</h3>
            <p class="text-stone text-sm">Add sites to generate a day-by-day plan</p>
          </div>
        </template>

        <!-- Days -->
        <template x-for="day in $store.tripPlanner.getDayByDayItinerary()" :key="day.number">
          <div class="mb-6">
            <!-- Day Header -->
            <div class="flex items-center gap-3 mb-3">
              <div class="w-12 h-12 rounded-full bg-gradient-to-br from-forest-600 to-forest-800 text-white flex items-center justify-center font-bold">
                <span x-text="day.number"></span>
              </div>
              <div>
                <h4 class="font-serif font-bold text-charcoal">Day <span x-text="day.number"></span></h4>
                <p class="text-xs text-stone">
                  <span x-text="day.sites.length"></span> sites ‚Ä¢
                  <span x-text="Math.round(day.totalHours * 10) / 10"></span>h total
                </p>
              </div>
            </div>

            <!-- Sites for this day -->
            <div class="ml-6 border-l-2 border-sand pl-4 space-y-3">
              <template x-for="(site, idx) in day.sites" :key="site.id">
                <div class="relative">
                  <!-- Timeline dot -->
                  <div class="absolute -left-[22px] top-3 w-3 h-3 rounded-full bg-forest-600 border-2 border-white"></div>

                  <!-- Site card -->
                  <div class="bg-white rounded-lg shadow-soft border border-sand p-3">
                    <h5 class="font-semibold text-charcoal text-sm mb-1" x-text="site.title"></h5>
                    <div class="text-xs text-stone flex flex-wrap items-center gap-2">
                      <span x-show="site.travelTime > 0" class="flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span x-text="site.travelTime + 'min travel'"></span>
                      </span>
                      <span class="flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        <span x-text="site.visitDuration + 'h visit'"></span>
                      </span>
                      <span class="flex items-center gap-1">
                        ‚Ç¨<span x-text="site.entryFee || 0"></span>
                      </span>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="border-t border-sand p-6 flex-shrink-0">
    <!-- Budget -->
    <div class="bg-cream rounded-xl p-4 mb-4">
      <div class="text-xs text-stone mb-1">Estimated Budget</div>
      <span class="text-2xl font-bold text-forest-700" x-text="'‚Ç¨' + $store.tripPlanner.totalBudget"></span>
    </div>

    <!-- Buttons -->
    <div class="grid grid-cols-2 gap-3 mb-4">
      <button
        @click="console.log('[BUTTON] Optimize clicked, sites:', $store.tripPlanner.sites.length); $store.tripPlanner.optimizeRoute()"
        :disabled="$store.tripPlanner.sites.length < 3"
        :class="$store.tripPlanner.sites.length < 3 ? 'cursor-not-allowed opacity-50' : ''"
        class="px-4 py-3 bg-forest-600 hover:bg-forest-700 disabled:bg-stone/30 text-white rounded-xl font-semibold transition-colors text-sm"
      >
        Optimize Route
        <span x-show="$store.tripPlanner.sites.length < 3" class="text-xs block">(Need 3+ sites)</span>
      </button>
      <button
        @click="$store.tripPlanner.openMap()"
        :disabled="$store.tripPlanner.sites.length === 0"
        class="px-4 py-3 bg-white hover:bg-cream border-2 border-forest-600 text-forest-600 rounded-xl font-semibold transition-colors text-sm disabled:opacity-50"
      >
        View Map
      </button>
    </div>

    <!-- Clear -->
    <button
      @click="$store.tripPlanner.clearTrip()"
      :disabled="$store.tripPlanner.sites.length === 0"
      class="w-full px-4 py-2 bg-white hover:bg-red-50 border border-sand hover:border-red-200 text-stone hover:text-red-600 rounded-lg font-medium transition-colors text-sm disabled:opacity-30"
    >
      Clear All
    </button>
  </div>
</div>

<!-- Map Modal -->
<div
  x-data="{ isOpen: false }"
  x-show="isOpen"
  @open-map.window="isOpen = true"
  @keydown.escape.window="isOpen = false"
  @click.self="isOpen = false"
  x-cloak
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
  style="display: none;"
  x-transition:enter="transition ease-out duration-300"
  x-transition:enter-start="opacity-0"
  x-transition:enter-end="opacity-100"
  x-transition:leave="transition ease-in duration-200"
  x-transition:leave-start="opacity-100"
  x-transition:leave-end="opacity-0"
>
  <div class="bg-white rounded-2xl shadow-2xl w-[90vw] h-[80vh] max-w-6xl flex flex-col">
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b border-sand">
      <h3 class="text-2xl font-serif font-bold text-charcoal">Trip Map</h3>
      <button
        @click="isOpen = false"
        class="p-2 hover:bg-cream rounded-lg transition-colors"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Map Container -->
    <div class="flex-grow relative">
      <div id="tripMap" class="w-full h-full"></div>
    </div>

    <!-- Footer -->
    <div class="p-4 border-t border-sand bg-cream">
      <p class="text-sm text-stone text-center">
        <span x-text="$store.tripPlanner.sites.length"></span> sites ‚Ä¢
        <span x-text="Math.round($store.tripPlanner.totalDistance)"></span> km ‚Ä¢
        <span x-text="$store.tripPlanner.getDaysNeeded()"></span> days
      </p>
    </div>
  </div>
</div>
